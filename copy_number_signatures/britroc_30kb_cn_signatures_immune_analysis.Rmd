---
title: "BriTROC 30kb CN signatures and immune marker analysis"
author: "Philip Smith"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

## Intial setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Load libraries

```{r library_load, warning=FALSE}
# Load required libraries with suppressed start-up text
library(tidyverse)
library(GGally)
library(cowplot)
library(ggpubr)
library(lmerTest)
library(lme4)
library(compositions)
library(logisticPCA)
```

### Source functions

```{r source_scripts}
# Load main functions
#source("data/britroc_30kb_functions.R")
#source("../colour_palettes.R")

plot_sigs_immune <- function(data=NULL,data2=NULL,marker=NULL){
    if(is.null(data)){
        stop("no data")
    }
    if(is.null(data2)){
        stop("no data")
    }
    if(is.null(marker)){
        stop("no marker")
    }
    if(!marker %in% unique(data$marker)){
        stop("marker not found")
    }
    #print(marker)
    immune.data.t <- data %>%
                            filter(marker == .env$marker, tissue == "tumour") %>%
                            arrange(normalised_cells)
    
    sig_bar.t <- data2[data2$SAMPLE_ID %in% immune.data.t$ID,]
    sig_bar.t$SAMPLE_ID <- factor(sig_bar.t$SAMPLE_ID,levels = unique(immune.data.t$ID[order(immune.data.t$normalised_cells)]))
    
    #return(unique(immune.data.t$ID[order(immune.data.t$normalised_cells,decreasing = T)]))
    
    sig_bar_plot.t <- ggplot(sig_bar.t) +
        geom_col(aes(SAMPLE_ID,value,fill=signature)) +
        scale_y_continuous(expand = c(0,0)) +
        scale_fill_manual(values = cbPalette) +
        ylab("exposure") +
        theme_bw() +
        theme(axis.text.x = element_blank(),
            axis.ticks.x = element_blank(),
            axis.title.x = element_blank(),
            legend.position = "none") + guides(fill=guide_legend(nrow=1,byrow=TRUE))
    
    sig_line_plot.t <- ggplot(sig_bar.t) +
        geom_line(orientation = "x",aes(SAMPLE_ID,value,group=signature,color=signature),alpha=0.5) +
        geom_smooth(aes(SAMPLE_ID,value,group=signature,color=signature),method = "lm",se = F) +
        scale_y_continuous(expand = c(0,0),limits = c(0,1)) +
        scale_color_manual(values = cbPalette) +
        facet_wrap(. ~ signature,nrow = 1) +
        ylab("exposure") +
        xlab(paste0("sample (tumour ",marker, ")")) +
        theme_bw() +
        theme(axis.text.x = element_blank(),
            axis.ticks.x = element_blank(),
            legend.position = "none") + guides(color=guide_legend(nrow=1,byrow=TRUE))
    
    immune.data.s <- data %>%
                        filter(marker == .env$marker, tissue == "stroma") %>%
                        arrange(normalised_cells)
    
    sig_bar.s <- data2[data2$SAMPLE_ID %in% immune.data.s$ID,]
    sig_bar.s$SAMPLE_ID <- factor(sig_bar.s$SAMPLE_ID,levels = unique(immune.data.s$ID[order(immune.data.s$normalised_cells)]))
    
    sig_bar_plot.s <- ggplot(sig_bar.s) +
        geom_col(aes(SAMPLE_ID,value,fill=signature)) +
        scale_y_continuous(expand = c(0,0)) +
        scale_fill_manual(values = cbPalette) +
        ylab("exposure") +
        theme_bw() +
        theme(axis.text.x = element_blank(),
            axis.ticks.x = element_blank(),
            axis.title.x = element_blank(),
            legend.position = "none") + guides(fill=guide_legend(nrow=1,byrow=TRUE))
    
    sig_line_plot.s <- ggplot(sig_bar.s) +
        geom_line(orientation = "x",aes(SAMPLE_ID,value,group=signature,color=signature),alpha=0.5) +
        geom_smooth(aes(SAMPLE_ID,value,group=signature,color=signature),method = "lm",se = F) +
        scale_y_continuous(expand = c(0,0),limits = c(0,1)) +
        scale_color_manual(values = cbPalette) +
        facet_wrap(. ~ signature,nrow = 1) +
        ylab("exposure") +
        xlab(paste0("sample (stroma ",marker, ")")) +
        theme_bw() +
        theme(axis.text.x = element_blank(),
            axis.ticks.x = element_blank(),
            legend.position = "none") + guides(color=guide_legend(nrow=1,byrow=TRUE))
    
    title <- ggdraw() + 
      draw_label(
        paste0(marker," (low to high cells / \u00b5m \u00b2)"),
        fontface = 'bold',
        x = 0,
        hjust = 0
    ) + theme(plot.margin = margin(0, 0, 0, 7))
    
    plot_grid(title,plot_grid(plot_grid(sig_bar_plot.t,sig_line_plot.t,nrow = 2),
             plot_grid(sig_bar_plot.s,sig_line_plot.s,nrow = 2),
             ncol = 2,labels = c("A","B","C")),rel_heights = c(0.1,1),nrow = 2)
}
```

### Read meta data

Meta data for all samples with fitted absolute copy number profiles, as well as genomic loci/annotation data for 16 frequently altered genes linked to high grade serous ovarian cancer.

```{r read_meta}
meta.data <- read.table("britroc_30kb_signature_data_meta.tsv",header = TRUE,sep = "\t")
patient.data <- read.table("../britroc_cohort_patient_data.tsv",header = TRUE,sep = "\t")
primary_resist_pats <- read.table("../britroc_primary_platinum_resistant_patient_list.tsv",header = T,sep = "\t")
```

### Load sig data

```{r meta.data}
# Load abs cn meta data and add arx/rlps annotation based on sample name prefix
load("britroc_30kb_signature_data.Rdata")
sig_quants <- t(sig_quants)
head(sig_quants)
```

### Load immune data

```{r immune}
immune.data_cd3_cd20_raw <- read.table("data/Clean_BRITROC_CD3_CD20.csv",header = T,sep = ",")
immune.data_cd8_foxp3_raw <- read.table("data/Clean_BRITROC_CD8_FOXP3.csv",header = T,sep = ",")

head(immune.data_cd3_cd20_raw)
head(immune.data_cd8_foxp3_raw)
```

```{r summarise_immune_table}
immune.data_cd3_cd20 <- immune.data_cd3_cd20_raw %>%
    mutate(image_id = paste(ID,row_number(),sep = "_")) %>%
    arrange(ID) %>%
    #select(ID,image_id,Image_Tag,9:ncol(.)) %>%
    dplyr::select(ID,image_id,Image_Tag,12:ncol(.)) %>%
    pivot_longer(cols = c(4,7),names_to = "tissue",values_to = "tissue_area") %>%
    mutate(tissue = case_when(str_split(tissue,pattern = "_",simplify = T)[,1] == "Tumour" ~ "tumour",
                              str_split(tissue,pattern = "_",simplify = T)[,1] == "Stroma" ~ "stroma")) %>%
    mutate(Stroma_CD3_Positive_Cells = ifelse(tissue == "tumour",NA,Stroma_CD3_Positive_Cells)) %>%
    mutate(Stroma_CD20_Positive_Cells = ifelse(tissue == "tumour",NA,Stroma_CD20_Positive_Cells)) %>%
    mutate(Tumour_CD3_Positive_Cells = ifelse(tissue == "stroma",NA,Tumour_CD3_Positive_Cells)) %>%
    mutate(Tumour_CD20_Positive_Cells = ifelse(tissue == "stroma",NA,Tumour_CD20_Positive_Cells)) %>%
    pivot_longer(cols = c(4:7),names_to = "marker",values_to = "cells") %>%
    mutate(marker = case_when(str_split(marker,pattern = "_",simplify = T)[,2] == "CD3" ~ "CD3",
                              str_split(marker,pattern = "_",simplify = T)[,2] == "CD20" ~ "CD20")) %>%
    filter(!is.na(cells))

    
#     
# mutate(tumour_CD3 = Tumour_CD3_Positive_Cells / Tumour_Tissue_Area) %>%
#     mutate(tumour_CD20 = Tumour_CD20_Positive_Cells / Tumour_Tissue_Area) %>%
#     mutate(stroma_CD3 = Stroma_CD3_Positive_Cells / Stroma_Tissue_Area) %>%
#     mutate(stroma_CD20 = Stroma_CD20_Positive_Cells / Stroma_Tissue_Area) %>%
#     select(image_id,ID,Image_Tag,tumour_CD3,tumour_CD20,stroma_CD3,stroma_CD20) %>%
#     pivot_longer(cols = -c(1:2),names_to = "marker",values_to = "normalised_cells") %>%
#     mutate(tissue = case_when(str_split(marker,pattern = "_",simplify = T)[,1] == "tumour" ~ "tumour",
#                               str_split(marker,pattern = "_",simplify = T)[,1] == "stroma" ~ "stroma")) %>%
#     mutate(marker = str_split(marker,pattern = "_",simplify = T)[,2])

immune.data_cd8_foxp3 <- immune.data_cd8_foxp3_raw %>%
    mutate(image_id = paste(ID,row_number(),sep = "_")) %>%
    arrange(ID) %>%
    #select(ID,image_id,9:ncol(.)) %>%
    dplyr::select(ID,image_id,Image_Tag,12:ncol(.)) %>%
    pivot_longer(cols = c(4,7),names_to = "tissue",values_to = "tissue_area") %>%
    mutate(tissue = case_when(str_split(tissue,pattern = "_",simplify = T)[,1] == "Tumour" ~ "tumour",
                              str_split(tissue,pattern = "_",simplify = T)[,1] == "Stroma" ~ "stroma")) %>%
    mutate(Stroma_CD8_Positive_Cells = ifelse(tissue == "tumour",NA,Stroma_CD8_Positive_Cells)) %>%
    mutate(Stroma_FOXP3_Positive_Cells = ifelse(tissue == "tumour",NA,Stroma_FOXP3_Positive_Cells)) %>%
    mutate(Tumour_CD8_Positive_Cells = ifelse(tissue == "stroma",NA,Tumour_CD8_Positive_Cells)) %>%
    mutate(Tumour_FOXP3_Positive_Cells = ifelse(tissue == "stroma",NA,Tumour_FOXP3_Positive_Cells)) %>%
    pivot_longer(cols = c(4:7),names_to = "marker",values_to = "cells") %>%
    mutate(marker = case_when(str_split(marker,pattern = "_",simplify = T)[,2] == "CD8" ~ "CD8",
                              str_split(marker,pattern = "_",simplify = T)[,2] == "FOXP3" ~ "FOXP3")) %>%
    filter(!is.na(cells))

    # mutate(all_CD8 = CD8_Positive_Cells / Tissue_Area) %>%
    # mutate(all_FOXP3 = FOXP3_Positive_Cells / Tissue_Area) %>%
    # mutate(tumour_CD8 = Tumour_CD8_Positive_Cells / Tumour_Tissue_Area) %>%
    # mutate(tumour_FOXP3 = Tumour_FOXP3_Positive_Cells / Tumour_Tissue_Area) %>%
    # mutate(stroma_CD8 = Stroma_CD8_Positive_Cells / Stroma_Tissue_Area) %>%
    # mutate(stroma_FOXP3 = Stroma_FOXP3_Positive_Cells / Stroma_Tissue_Area) %>%
    # select(image_id,ID,tumour_CD8,tumour_FOXP3,stroma_CD8,stroma_FOXP3) %>%
    # pivot_longer(cols = -c(1:2),names_to = "marker",values_to = "normalised_cells") %>%
    # mutate(tissue = case_when(str_split(marker,pattern = "_",simplify = T)[,1] == "tumour" ~ "tumour",
    #                           str_split(marker,pattern = "_",simplify = T)[,1] == "stroma" ~ "stroma")) %>%
    # mutate(marker = str_split(marker,pattern = "_",simplify = T)[,2])

all(immune.data_cd3_cd20$ID %in% immune.data_cd8_foxp3$ID)
all(immune.data_cd8_foxp3$ID %in% immune.data_cd3_cd20$ID)
overlapping_samples <- intersect(immune.data_cd3_cd20$ID,immune.data_cd8_foxp3$ID)
```

```{r combined_immune}
immune.data <- rbind(immune.data_cd3_cd20,immune.data_cd8_foxp3)

## Add new marker for total t-cell population (CD3 + CD8)
## This is actually challenging as CD3 and CD8 are on different raw input files so the
## relationship between cell counts is hard to identify. Here I assume that matching sample id and image_tag
## relate to a single image with different stains, I sum the cells across both markers and take the median tissue area
# immune.data <- immune.data %>%
#     filter(ID %in% overlapping_samples) %>%
#     group_by(ID,tissue,Image_Tag) %>%
#     #group_map(~.x) 
#     group_modify(~ add_row(.x,data.frame(image_id=.$image_id[1],
#                                tissue_area=median(.$tissue_area[.$marker == "CD3"],.$tissue_area[.$marker == "CD8"],na.rm = T),
#                                marker="tCD3",
#                                cells=(.$cells[.$marker == "CD3"] + .$cells[.$marker == "CD8"]))))
immune.data <- immune.data %>%
                mutate(normalised_cells = cells/tissue_area) %>%
                #filter(ID %in% overlapping_samples) %>%
                filter(!is.na(normalised_cells)) %>%
                dplyr::select(-cells,-tissue_area) %>%
                filter(marker %in% c("CD3","CD8"))

head(immune.data)
```

```{r plot_immune_summary,fig.width=12}
ggplot(immune.data) +
    geom_density(aes(log1p(normalised_cells),color=marker)) +
    facet_wrap(tissue ~ marker,scales = "free",ncol = 4) +
    ylab("cells / \u00b5m \u00b2") +
    theme_bw() +
    theme(axis.title.x = element_blank())

ggplot(immune.data) +
    geom_bar(aes(ifelse(normalised_cells > 0,TRUE,FALSE),fill=marker)) +
    facet_wrap(tissue ~ marker,scales = "free",ncol = 4) +
    ylab("zero value count") +
    theme_bw() +
    theme(axis.title.x = element_blank())
```

```{r plot_immune_corr,fig.width=12,warning=FALSE}
immune.data.wide <- immune.data %>%
                      mutate(normalised_cells = log1p(normalised_cells)) %>%
                      pivot_wider(id_cols = c("Image_Tag","ID","tissue"),
                                  names_from = marker,values_from = normalised_cells)

pairs_plot <- GGally::ggpairs(immune.data.wide,
                              aes(color=tissue),
                              upper = list(continuous = wrap("cor", method = "spearman")),
                              columns = 4:5) +
              theme_bw()

saveRDS(object = pairs_plot,file = "plots/immune_marker_pairs_plot.RDS")
ggsave(pairs_plot,filename = "plots/immune_marker_pairs_plot.png",width = 8,height = 6,units = "in",dpi = 300)
ggsave(pairs_plot,filename = "plots/immune_marker_pairs_plot.pdf",width = 8,height = 6,units = "in",dpi = 300)
pairs_plot
```

```{r subset_signatures}
sig_quants <- sig_quants[row.names(sig_quants) %in% immune.data$ID,]

sample_order <- rownames(sig_quants[order(sig_quants[,1],sig_quants[,2],sig_quants[,3],
                                            sig_quants[,4],sig_quants[,5],sig_quants[,6],decreasing = T),])
```

```{r format_sigs}
sig_bar <- as.data.frame(t(sig_quants)) %>%
    rownames_to_column(var = "signature") %>%
    pivot_longer(cols = -1,names_to="SAMPLE_ID")
```

```{r plot_sigs_natural,fig.width=12}
sig_bar$SAMPLE_ID <- factor(sig_bar$SAMPLE_ID,levels = sample_order)

sig_bar_plot <- ggplot(sig_bar) +
    geom_col(aes(SAMPLE_ID,value,fill=signature)) +
    scale_y_continuous(expand = c(0,0)) +
    #scale_fill_manual(values = cbPalette) +
    ylab("exposure") +
    theme_bw() +
    theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "none") + guides(fill=guide_legend(nrow=1,byrow=TRUE))

sig_line_plot <- ggplot(sig_bar) +
    geom_line(orientation = "x",aes(SAMPLE_ID,value,group=signature,color=signature),alpha=0.5) +
    geom_smooth(aes(SAMPLE_ID,value,group=signature,color=signature),method="lm",se = F) +
    scale_y_continuous(expand = c(0,0),limits = c(0,1)) +
    #scale_color_manual(values = cbPalette) +
    facet_wrap(. ~ signature,nrow = 1) +
    ylab("exposure") +
    xlab("sample") +
    theme_bw() +
    theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "bottom") + guides(color=guide_legend(nrow=1,byrow=TRUE))

plot_grid(sig_bar_plot,sig_line_plot,nrow = 2)
```

```{r plot_sigs,fig.width=12}
# CD3_plot <- plot_sigs_immune(data = immune.data,data2 = sig_bar,marker = "CD3")
# CD3_plot

# CD20_plot <- plot_sigs_immune(data = immune.data,data2 = sig_bar,marker = "CD20")
# CD20_plot

# CD8_plot <- plot_sigs_immune(data = immune.data,data2 = sig_bar,marker = "CD8")
# CD8_plot

# FOXP3_plot <- plot_sigs_immune(data = immune.data,data2 = sig_bar,marker = "FOXP3")
# FOXP3_plot
```

```{r sig_immune_comb}
sig_immune <- as.data.frame(sig_quants) %>%
    rownames_to_column(var = "ID") %>%
    left_join(immune.data,.,by="ID") %>%
    pivot_longer(cols = 7:ncol(.),names_to = "signature",values_to = "exposure") %>%
    filter(!is.na(exposure))

sig_immune$patient_id <- meta.data$PATIENT_ID[match(sig_immune$ID,meta.data$SAMPLE_ID)]
sig_immune <- sig_immune %>%
                filter(!is.na(patient_id))
head(sig_immune,n = 10)
#write.table(sig_immune,file = "data/britroc_immune_data.tsv",quote = F,sep = "\t",row.names = F,col.names = T)
```

```{r sig_immune_plot,fig.width=12}
sig_immune_cor_t <- ggplot(sig_immune[sig_immune$tissue == "tumour",]) +
    geom_point(aes(log1p(normalised_cells),exposure,color=signature)) +
    geom_smooth(aes(log1p(normalised_cells),exposure),method = "lm",se=F) +
    scale_y_continuous(limits = c(0,1)) +
    facet_wrap(marker ~ signature,scales = "free_x",ncol = 7) +
    stat_cor(aes(log1p(normalised_cells),exposure),label.sep = "\n",
             r.digits = 2,
             size = 2.5,
             label.x.npc = 0.4,
             label.y.npc = 0.82,
             p.digits = 2,
             method = "spearman") +
    labs(title = "tumour") +
    xlab("log1p(cells / \u00b5m \u00b2)") +
    theme_bw() +
    theme(legend.position = "none",
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank())

sig_immune_cor_s <- ggplot(sig_immune[sig_immune$tissue == "stroma",]) +
    geom_point(aes(log1p(normalised_cells),exposure,color=signature)) +
    geom_smooth(aes(log1p(normalised_cells),exposure),method = "lm",se=F) +
    scale_y_continuous(limits = c(0,1)) +
    facet_wrap(marker ~ signature,scales = "free_x",ncol = 7) +
    stat_cor(aes(log1p(normalised_cells),exposure),label.sep = "\n",
             r.digits = 2,
             size = 2.5,
             label.x.npc = 0.4,
             label.y.npc = 0.82,
             p.digits = 2,
             method = "kendall") +
    labs(title = "stroma") +
    xlab("log1p(cells / \u00b5m \u00b2)") +
    theme_bw() +
    theme(legend.position = "none",
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank())

sig_immune_cor <- plot_grid(sig_immune_cor_t,sig_immune_cor_s,nrow = 2,labels = c("A","B"))

saveRDS(object = sig_immune_cor,file = "plots/sig_immune_cor.RDS")
ggsave(sig_immune_cor,filename = "plots/sig_immune_cor.png",width = 8,height = 8,units = "in",dpi = 300)
ggsave(sig_immune_cor,filename = "plots/sig_immune_cor.pdf",width = 8,height = 8,units = "in",dpi = 300)
sig_immune_cor
```

```{r glmm_data_prep}
sig_immune$status <- patient.data$pt_sensitivity_at_reg[match(gsub(sig_immune$patient_id,
                                                                  pattern = "BRITROC-",replacement = ""),patient.data$britroc_number)]

sig_immune <- droplevels(sig_immune)
head(sig_immune)
```

# STEPS

  ## Randomly sample a single sample from each patient
    ## check for outlier samples 
  ## Determine model family from immune cell dists.
  ## Transform signatures
    ### Dichotomised
    ### ILR with imputation
    ### ALR
    ### Dichotomised logistic PCA
  ## Other covariates? Pt_status?
  ## Compare with and without signatures in model using LHR / anova
  ## All markers or separate model for each marker of interest?
  

```{r setseed}
set.seed(seed = 9990)
```

```{r patient_sampling}
## Gather patient-sample table from long data
patient_groups <- sig_immune %>%
  dplyr::select(ID,patient_id) %>%
  distinct() %>%
  arrange(patient_id)

## Randomly sample single sample_id for each patient
patient_groups_sampled <- patient_groups %>%
                            group_by(patient_id) %>%
                            # sampling rows by grouped tibble
                            slice_sample(n = 1)

## Check sample counts per patient
table(patient_groups_sampled$patient_id)

sig_immune_subset <- sig_immune %>%
                      filter(ID %in% patient_groups_sampled$ID)
head(sig_immune_subset)
```

```{r add_clin_feats}
sig_immune_subset <- sig_immune_subset %>%
                      mutate(age = patient.data$age[match(patient_id,paste0("BRITROC-",patient.data$britroc_number))]) %>%
                      mutate(stage = as.factor(patient.data$tumour_stage_at_diagnosis[match(patient_id,paste0("BRITROC-",patient.data$britroc_number))]))
head(sig_immune_subset)
```

```{r exposure_transformation}
sig_immune_subset$exposure_dichot <- ifelse(sig_immune_subset$exposure > 0,1,0) # potentially wrong? 
```

```{r exposure_logisticPCA}
sig_dichot_wide <- sig_immune_subset %>%
                    dplyr::select(-exposure) %>%
                    pivot_wider(names_from = signature,values_from = exposure_dichot)

head(sig_dichot_wide[,9:ncol(sig_dichot_wide)])
dim(sig_dichot_wide[,9:ncol(sig_dichot_wide)])

logiPCA <- logisticPCA::logisticPCA(sig_dichot_wide[,9:ncol(sig_dichot_wide)],m = 0,k = 7)
logiSVD <- logisticSVD(sig_dichot_wide[,9:ncol(sig_dichot_wide)],k=5)

head(logiSVD$A) ## USe this one
dim(logiSVD$A)
head(logiSVD$B)
dim(logiSVD$B)
plot(logiSVD, type = "scores")

head(logiPCA$PCs)
dim(logiPCA$PCs)
plot(logiPCA)
plot(logiPCA, type = "scores") 
```

```{r ALR}
sig_wide_alr <- sig_immune_subset %>%
                    dplyr::select(-exposure_dichot) %>%
                    pivot_wider(names_from = signature,values_from = exposure)
acomp()
compositions::alr(sig_wide[,9:ncol(sig_wide)])
temp0 = sig_wide[,9:ncol(sig_wide)]
```

```{r ILR}
sig_wide_ilr <- sig_immune_subset %>%
                    dplyr::select(-exposure_dichot) %>%
                    pivot_wider(names_from = signature,values_from = exposure)

factor(apply(temp1==0,1,function(x)paste0(as.numeric(x),collapse=""))) 
compositions::ilr() 
# dom used this over alr
# below detection limit - doms code below
   # temp1 = na.omit(temp0)
   # colw  = factor(apply(temp1==0,1,function(x)paste0(as.numeric(x),collapse=""))) 
   # temp2 = ilr(acomp(temp1))
   # temp2b = temp0[,1:6]
   # temp2b[!apply(is.na(temp0),1,any),] = temp2
   # colnames(temp2b) = paste0("compBDL",1:6)
```

## Add signatures

```{r lmer_model}
sig_immune_subset_list <- split(sig_immune_subset,f = as.factor(sig_immune_subset$marker))

x <- sig_immune_subset_list[[3]]
head(x)

x %>%
  dplyr::select(-exposure) %>%
  pivot_wider(names_from = "signature",values_from = "exposure_dichot")

x[x$patient_id == "BRITROC-55",] # two images from one sample/patient from two tissue types

glmmR <- lmerTest::lmer(log1p(normalised_cells) ~ tissue + (1|patient_id/image_id),data = x)
glmm <- lmerTest::lmer(log1p(normalised_cells) ~ exposure + + tissue + (1|patient_id/image_id),data = x)

summary(glmm)
x$residual <- resid(glmm)

ggplot(x) +
      geom_boxplot(aes(tissue,residual)) +
      theme_bw()

ggplot(x) +
      geom_boxplot(aes(patient_id,residual)) +
      theme_bw() +
      theme(axis.text.x = element_blank(),
            axis.ticks.x = element_blank())
    

aov <- anova(glmmR,glmm)
aov
```


```{r lmer_model_1}
sig_immune_subset_list <- split(sig_immune_subset,f = as.factor(sig_immune_subset$marker))

glmm_out <- lapply(sig_immune_subset_list,FUN = function(x){
  glmmR <- lmerTest::lmer(log1p(normalised_cells) ~ tissue + (1|patient_id),
                        data = x)
  glmm <- lmerTest::lmer(log1p(normalised_cells) ~ exposure_dichot + tissue + (1|patient_id),
                       data = x)
  ## Add residual and plot
  x$residual <- resid(glmm) ## variance across tissue and patient.
  return(list(glmm,glmmR,x))
})

plot_residuals <- function(x = glmm_out){
  lapply(x,FUN = function(y){
    tissue_res <- ggplot(y[[3]]) +
      geom_boxplot(aes(tissue,residual)) +
      theme_bw()
    patient_res <- ggplot(y[[3]]) +
      geom_boxplot(aes(patient_id,residual)) +
      theme_bw() +
      theme(axis.text.x = element_blank(),
            axis.ticks.x = element_blank())
    plot_grid(tissue_res,patient_res,nrow = 2)
  })
}

compare_models <- function(x = glmm_out){
  aov_out <- list()
  lapply(x,FUN = function(y){
    aov <- anova(y[[1]],y[[2]])
  })
}


compare_models(glmm_out)
plot_residuals(glmm_out)

## if different then inclusion in the model expressed as a function of variance by modelling heteroscadacity
## Still assumption of normal distribution of residuals and random effects
## Assumption of homoscecdacity
```

```{r test_glmm}
anova(glmmR,glmm) ## lmerTest-specific method
```

```{r diag_relapse}
sig_immune$group <- ifelse(gsub(sig_immune$patient_id,pattern = "BRITROC-",replacement = "") %in% im_list,"im_list","non-im_list")

ggplot(sig_immune[sig_immune$tissue == "tumour" & sig_immune$marker == "CD8",]) +
    geom_point(aes(y=normalised_cells,x=group,color=group),position = position_dodge2(width = 0.3)) +
    geom_violin(aes(y=normalised_cells,x=group,color=group),fill=NA,position = "dodge") +
    #geom_smooth(aes(log(normalised_cells),exposure),method = "lm",se=F) +
    facet_grid(cols = vars(signature)) +
    # stat_cor(aes(log(normalised_cells),exposure),label.sep = "\n",
    #          r.digits = 2,
    #          p.digits = 2,
    #          method = "spearman") +
    labs(title = "tumour") +
    xlab("patient group") +
    theme_bw() +
    theme(legend.position = "none",axis.text.x = element_text(angle = 90))

ggplot(sig_immune[sig_immune$tissue == "stroma" & sig_immune$marker == "CD8",]) +
    geom_point(aes(y=normalised_cells,x=group,color=group),position = position_dodge2(width = 0.3)) +
    geom_violin(aes(y=normalised_cells,x=group,color=group),fill=NA,position = "dodge") +
    #geom_smooth(aes(log(normalised_cells),exposure),method = "lm",se=F) +
    facet_grid(cols = vars(signature)) +
    # stat_cor(aes(log(normalised_cells),exposure),label.sep = "\n",
    #          r.digits = 2,
    #          p.digits = 2,
    #          method = "spearman") +
    labs(title = "stroma") +
    xlab("patient group") +
    theme_bw() +
    theme(legend.position = "none",axis.text.x = element_text(angle = 90))
```

```{r session.info}
sessionInfo()
```
